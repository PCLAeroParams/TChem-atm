name: auto_test

# This action is triggered:
# 1. when someone creates a pull request for a merge to the main branch
# 2. when changes are merged into the main branch (via a pull request)
# 3. weekly at a scheduled time (UTC)
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 6 * * 0'

# Below are jobs, each of which runs sequentially.
jobs:
  # This job builds the box model and runs our test suite.
  build:
    # A build matrix storing all desired configurations.
    strategy:
      matrix:
        os: [ubuntu-22.04] #, macos-latest]
        build-type: [Release, Debug]
        sacado-on: [ON, OFF]
        #fp-precision: [double] # single is not working for tchem.

    runs-on: ${{ matrix.os }}

    # Environment variables
    env:
      CI: 1   # indicates that we are running in a CI environment.

    # Steps for building and running tests.
    steps:
    - name: Checking out repository
      uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path:  /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ matrix.build-type }}-${{ matrix.sacado-on }}-${{ hashFiles('Dockerfile', 'external/**') }}
        restore-keys: |
          ${{ runner.os }}-buildx-${{ matrix.build-type }}-${{ matrix.sacado-on }}-
          ${{ runner.os }}-buildx-

    - name: Building TChem (${{ matrix.build-type }}, ${{ matrix.sacado-on }} sacado)
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile
        push: false
        load: true
        tags: tchem:latest
        progress: plain
        build-args: |
          BUILD_TYPE=${{ matrix.build-type }}
          SACADO=${{ matrix.sacado-on }}
          BUILDKIT_INLINE_CACHE=1
        cache-from: |
          type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache-new,mode=max

    - name: Move cache
      run: |
        rm -rf /tmp/.buildx-cache
        mv /tmp/.buildx-cache-new /tmp/.buildx-cache

    - name: Testing TChem
      run: |
        if [ "${{ matrix.build-type }}" == "Debug" ] && [ "${{ matrix.sacado-on }}" == "OFF" ]; then
          echo "Running tests with coverage generation..."
          docker run -t -v "$PWD:/shared" tchem:latest bash -c 'cd /tchem_build && ctest --output-on-failure && make coverage && mv coverage.info /shared'
        else
          echo "Running tests without coverage (build-type=${{ matrix.build-type }}, sacado=${{ matrix.sacado-on }})..."
          docker run -t -v "$PWD:/shared" tchem:latest bash -c 'cd /tchem_build && ctest --output-on-failure'
        fi

    - name: Uploading coverage report to codecov.io
      if: ${{ (contains(matrix.os, 'ubuntu')) && (matrix.build-type == 'Debug') && (matrix.sacado-on == 'OFF') }}
      uses: codecov/codecov-action@v3
      with:
        fail_ci_if_error: true
        files: coverage.info
        name: TChem-atm
        token: ${{ secrets.CODECOV_TOKEN }}
        verbose: true
        commit_sha: ${{ github.sha }}
        slug: ${{ github.repository }}
